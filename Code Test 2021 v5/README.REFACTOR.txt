
I only have a few opinion about the code specialy when there is a long process of logic 
why not proccess it in a separate class like you can create a service class where it will 
holds all of the business logic for it. Some conditions are redundant we can create a separate 
class to be reusable. Separating business logic will more readable and shorten the lines of code 
in the repository. Over all code base is fine specialy it is using a repository pattern.